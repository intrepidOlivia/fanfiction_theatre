<!DOCTYPE html>
<html lang="en">
<head>
    <!-- To add new images to the gallery: Add the image files to assets/gallery.
        Then run the sync_gallery.sh script to add the images to the config.
        You can edit the title and description in gallery_config.json.
    -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fan Art Gallery - Fanfiction Theatre</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/gallery.css">
</head>
<body>
    <h1 style="text-align:center; margin-top:24px;">Fan Art Gallery</h1>
    <div class="gallery" id="gallery">
        <!-- Thumbnails will be injected here -->
    </div>

    <div class="dialog-overlay" id="dialogOverlay">
        <div class="dialog" id="dialog">
            <button class="close-btn" id="closeBtn">&times;</button>
            <img id="dialogImg" src="" alt="" loading="lazy">
            <div class="details">
                <h2 id="dialogTitle"></h2>
                <p id="dialogDesc"></p>
            </div>
        </div>
    </div>

    <script>
        const gallery = document.getElementById('gallery');
        const dialogContent = document.getElementById('dialog');
        const dialogOverlay = document.getElementById('dialogOverlay');
        const dialogImg = document.getElementById('dialogImg');
        const dialogTitle = document.getElementById('dialogTitle');
        const dialogDesc = document.getElementById('dialogDesc');
        const closeBtn = document.getElementById('closeBtn');
        const CONFIG_FILE = 'gallery_config.json';
        let images = [];
        const hashMap = {};

        init();

        function init() {
            fetch(CONFIG_FILE)
                .then(response => response.json())
                .then(data => {
                images = data;
                images.forEach((img, idx) => {
                    const thumb = document.createElement('img');
                    const path = img.src.split('/');
                    thumb.src = img.thumb;
                    thumb.alt = img.title;
                    thumb.className = 'thumbnail';
                    thumb.dataset.idx = idx;
                    thumb.dataset.hash = path[path.length - 1].split('.')[0];
                    thumb.onclick = onClickOpenDialog;
                    hashMap[thumb.dataset.hash] = idx;
                    gallery.appendChild(thumb);
                });

                // Check initial url hash to see if a dialog should open
                const hash = window.location.hash.slice(1);
                if (hashMap[hash]) {
                    openDialog(hashMap[hash], hash);
                }
            });
        }

        function onClickOpenDialog(e) {
            const idx = e.target.dataset.idx;
            const hash = e.target.dataset.hash;
            openDialog(idx, hash);
            e.stopPropagation();
        }

        function openDialog(idx, hash) {
            const img = images[idx];
            window.location.hash = hash;
            dialogImg.src = img.src;
            dialogImg.alt = img.title;
            dialogTitle.textContent = img.title;
            dialogDesc.textContent = img.desc;
            dialogOverlay.style.display = 'flex';
            dialogOverlay.addEventListener('click', dialogCloseListener);
        }

        function closeDialog() {
            dialogOverlay.style.display = 'none';
            window.location.hash = '';
            gallery.removeEventListener('click', dialogCloseListener);
        }

        function dialogCloseListener(e) {
            if (!dialogContent.contains(e.target)) {
                closeDialog();
            }
        }

        closeBtn.addEventListener('click', function() {
            closeDialog();
        });

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeDialog();
            }
        });
    </script>
</body>
</html>